<!--
    Template page, copy and paste to use
-->

<!doctype html>
<html lang="en">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="./lib/custom/main.css">
      <link rel="stylesheet" href="./lib/css/bootstrap.min.css">
      <title>Trader APP</title>
   </head>
   <body>
      <!-- ================================================ Top Navbar ================================================ -->
      <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" id="navbar_top">
         <div class="navbar-header">
            <a class="navbar-brand" href="#">
            <i class="fa fa-copyright"></i>&nbsp;Trader APP</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbar2SupportedContent">
               <span class="navbar-toggler-icon"></span>
               <p> <font color="white">v0.0.1 </font></p>
            </button>
         </div>
      </nav>
      <!-- ================================================ Landing Page ================================================ -->
      <div class="container-fluid">
         <div class="container jumbotron">
            <h1 align="center">Trader App Editor</h1>
            <br>
            <div class="row">
              <div class="col-md-3">
                <h5>Policy List</h5>
                <div id="policy-list-bg">
                  <ul id="policy-list" class="list-group">
                    <!-- Responsive policy list goes here -->
                  </ul>
                </div>
              </div>
              <div class="col-md-9">
                <h5>Editor Panel</h5>
                <span class="badge badge-secondary">
                  <h7>File Name : </h7>
                </span>
                <span id="file-name"></span>
                <span class="badge badge-secondary">
                  <h7>Owner : </h7>
                </span>
                <span id="file-owner"></span>
                <!-- for resize for editor to fit parent div -->
                <div id="editorContainer">
                   <!-- editor panel -->
                   <div id="aceEditor">
                      Do something here...  
                   </div>
                   <!-- editor goes here -->
                </div>
                <div class="fileOpen btn btn-primary btncustom">
                  <span>OPEN</span>
                  <input type="file" id="file-input" class="open" multiple>
                </div>
                <button type="button" class="btn btn-success btncustom" id="file-save">SAVE</button>&nbsp;&nbsp;
                <button type="button" class="btn btn-danger btncustom" id="file-discard">DISCARD</button>
                </div>
         </div>
      </div>
      <!-- ================================================ Bottom Navbar ================================================ -->
      <div class="navbar fixed-bottom navbar-expand-md bg-dark navbar-dark text-nowrap">
         <span class="hide-phone footer-link">
         <a class="navbar-brand mx-auto px-5" href="#">Copyright Â© 2018 by Kevin Cyu. All rights reserved.</a>
         </span>
         <span style="float:right;"><font color="white">EFACANI, Trader App Team</font></span>
      </div>
   </body>
<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<!-- In Electron, this is the correct way to include jQuery -->
<script>window.$ = window.jQuery = require('./lib/js/jquery-3.3.1.min.js');</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.3/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script>
var policyList = $("#policy-list");
var editor;
var isSaved = true;
var nowFile = "";
const policy_path = './.local/policy';
const fs = require('fs');


// Function goes here
function initPolicyList(){
  fs.readdir(policy_path, (err, files) => {
    files.forEach(file => {
      $('<li class="list-group-item list-group-item-action" id="'+file+'">' + file + '</li>').appendTo(policyList);
    });
  })
}

function refleshPolicyList(){
  $('ul').empty();
  initPolicyList();
}

function readSingleFile(e) {
  if(!isSaved){
    if (confirm("Save this Policy before upload another Policy?")){
      var title = document.getElementById('file-name').innerText;
      saveFiles(title,editor.getValue());
    }
  }
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  document.getElementById('file-name').innerText = file.name; 
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    editor.setValue(contents);
    editor.session.getUndoManager().markClean();
  };
  reader.readAsText(file);
  $("#file-input").val('');
}

function initAceEditor() {
    editor = ace.edit("aceEditor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/yaml");
    editor.getSession().setOptions({newLineMode: "auto"});
    editor.setFontSize("15px") ;
    editor.setPrintMarginColumn(false);
    editor.setOptions({
        autoScrollEditorIntoView: true,
        copyWithEmptySelection: true,
        animatedScroll: true
    })
    editor.setOption("mergeUndoDeltas", "always");
}

function clearEditor(){
  editor.setValue("");
}

function setPolicyToEditor(policy_name){
  var csvRequest = new Request({
    url:"../.local/policy/"+policy_name,
    onSuccess:function(response){
      editor.setValue(response);
      editor.session.getUndoManager().markClean();
    }
    }).send();
}

function saveFiles(file_name,file_data){
  fs.writeFile(policy_path+"/"+file_name, file_data, function(err) {
    if(err) {
      alert("File save ERROE!");
      return console.log(err);
    }
    alert("The file was saved!");
    console.log("The file was saved!");
    refleshPolicyList();
    isSaved = true;
  });
}

function deleteFiles(file_name){
  if (confirm("Sure to Delete this Policy?")) {
      fs.unlink(policy_path+"/"+file_name, (err) => {
        if (err){
          alert("Delete file failed!");
          throw err;
        }
        alert("File deleted successfully!");
        console.log('The file was deleted');
        clearEditor();
        refleshPolicyList();
        isSaved = true;
      });
  }
}

// initial Ace Editor
initAceEditor();
editor.session.getUndoManager().reset();

//This event is called when the DOM is fully loaded
window.addEvent("domready",function(){
  initPolicyList();
});

//Event goes here
document.getElementById("policy-list").addEventListener("click",function(e) {
  if(!editor.session.getUndoManager().isClean()){
    if (confirm("Save this Policy before open another Policy?")){
      var title = document.getElementById('file-name').innerText;
      saveFiles(title,editor.getValue());
      editor.session.getUndoManager().reset();
    }
  }
  if(e.target && e.target.nodeName == "LI") {
    setPolicyToEditor(e.target.id);
    document.getElementById('file-name').innerText = e.target.id;
    isSaved = false;
  }
});

$(document).on('change','#file-input',function(e){ 
  readSingleFile(e); 
});

$( "#file-save" ).click(function() {
  var title = document.getElementById('file-name').innerText;
  saveFiles(title,editor.getValue());
});

$( "#file-discard" ).click(function() {
  var title = document.getElementById('file-name').innerText;
  deleteFiles(title);
});

</script>
</html>
